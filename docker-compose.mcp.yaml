# Standalone MCP server with HTTP transport
#
# This docker-compose file runs the Deriva MCP server in HTTP mode,
# which provides persistent connections that survive client disconnects
# and support long-running operations like catalog cloning.
#
# Prerequisites:
#   - The deriva-localhost Docker network must exist (from deriva-localhost stack)
#   - Deriva credentials in ~/.deriva/
#
# Usage:
#   # Start the MCP server
#   docker-compose -f docker-compose.mcp.yaml up -d
#
#   # View logs
#   docker-compose -f docker-compose.mcp.yaml logs -f
#
#   # Stop the server
#   docker-compose -f docker-compose.mcp.yaml down
#
# Claude Code configuration (~/.mcp.json):
#   {
#     "mcpServers": {
#       "deriva-ml": {
#         "type": "http",
#         "url": "http://localhost:8000/mcp"
#       }
#     }
#   }

services:
  deriva-mcp:
    image: ghcr.io/informatics-isi-edu/deriva-mcp:latest
    container_name: deriva-mcp
    command:
      - deriva-mcp
      - --transport
      - streamable-http
      - --host
      - "0.0.0.0"
      - --port
      - "8000"
    extra_hosts:
      - "localhost:172.28.3.250"
    networks:
      - deriva-localhost_internal_network
    ports:
      - "8000:8000"
    volumes:
      # Mount credentials read-only for security
      - ${HOME}/.deriva:${HOME}/.deriva:ro
      # BDBag keychain for dataset operations
      - ${HOME}/.bdbag:${HOME}/.bdbag
      # DerivaML working directory
      - ${HOME}/.deriva-ml:${HOME}/.deriva-ml
      # Persistent task storage (survives container restarts)
      - deriva-mcp-data:/app/data
    environment:
      - HOME=${HOME}
      # Task persistence configuration
      - DERIVA_MCP_TASK_STATE_PATH=/app/data/task_state.json
      - DERIVA_MCP_TASK_RETENTION_HOURS=168
      - DERIVA_MCP_TASK_SYNC_INTERVAL=5
      # SSE keepalive to prevent proxy timeouts
      - DERIVA_MCP_SSE_KEEPALIVE=30
      # Remap 'localhost' to Docker DNS name for network access to Deriva server
      - DERIVA_MCP_LOCALHOST_HOSTNAME=deriva
      # CA bundle for self-signed localhost certificates
      # pip-system-certs/truststore ignores REQUESTS_CA_BUNDLE but respects SSL_CERT_FILE
      - SSL_CERT_FILE=${HOME}/.deriva/allCAbundle-with-local.pem
    restart: unless-stopped
    healthcheck:
      # Health check uses dedicated /health endpoint that does NOT create MCP sessions.
      # Using /mcp would create orphan sessions every 30 seconds, causing resource exhaustion.
      test: ["CMD", "curl", "-sf", "--max-time", "2", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  # Named volume for persistent task state
  deriva-mcp-data:

networks:
  # Use the existing network from deriva-localhost stack
  # This allows the MCP server to communicate with the Deriva webserver
  deriva-localhost_internal_network:
    external: true
